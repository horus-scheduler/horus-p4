# saqr-p4
This repo contains the P4 switch implementation for **Saqr: Distributed In-network Task Scheduler for Datacenters**.

## Repository Structure

p4_16/targets/[tofino](https://github.com/parhamyassini/saqr-p4/tree/master/p4_16/targets/tofino) Contains the P4-16 programs written for TNA architecture. 
There are three main programs in this repository. The headers and parsers are common between these programs. Each program contains leaf and spine logic and runs each on one of the hardware pipelines and a controller which configures the tables.  
1. Saqr
Under the directory "saqr". Contains the Saqr implementation for TNA architecture. 
 
2. RS-R
 Contains the implementation of [RackSched](https://github.com/netx-repo/RackSched) in P4-16 for leaf switches. We only added the necessary codes to support multiple virtual clusters and support large number of nodes. The code uses virtual cluster feature to emulate multiple leaf switches in our testbed topology (as explained in next section). 
The spine switch randomly selects one of the racks for a task.

3. RS-H 
 Similar to RS-R but we have extended the solution to support multiple racks using by replicating the RackSched logic at both spine and leaf layers. In leaf program, we add support for sending state updates from leaf to spine. In this setup, each leaf scheduler keeps track of average load in rack and sends this value to the spine after receiving a reply from a worker in the rack.
The spine implements the Racksched policy and similar to leaf switches, uses power-of-two choices to select a rack for a task. 

## Experiment Setup
### Network topology and switch connections
The figure below shows the high-level design of the testbed setup used in our experiments: 
We use two machines as clients and four *or* five machines as workers (depending on Skewed or Balanced placement experiments).

![Highlevel Testbed Setup](./figs/testbed_setup.png)

The figure below shows the exact connections between switch ports and machines in our testbed:

![Switch Setup](./figs/switch_connection_setup.png)

### Emulating multiple leafs using P4 Program
The current implementation uses the Virtual Cluster (VC) feature to emulate different leafs. The spine program assigns the ```hdr.falcon.cluster_id``` based on the selected leaf (this is done when selecting output port). Therfore, each leaf will only have access to the workers in that cluster. 
 The leaf programs first checks the ```hdr.falcon.cluster_id```, and based on that each leaf has access to an isolated part of the register arrays. In Saqr, each VC has the following registers:   linkage register, Load list register arrays (including the load and drift arrays), idle counter register (used as pointer to the idle list) and idle list register array. 
The controller is responsible for managing this virtualization as it configures the intial setup for the placement of workers. The current controller codes provide two setup configs used in our experiments: Skewed and Uniform.
The physical connections between machines and switch do not need to be changed for the two mentioned setps.
XXX Describe how controller changes setup and how worker configs should change (refer to the app-evals repo).

### Instructions for making new placement setups
XXX

## Building and Running the Codes

#### SSH to the switch 
```
ssh p4@142.58.2.222
```
> Note: Switch can be accessed from any machine from *witihn* the SFU network. 

#### Clone the repository.

#### Build the P4 Programs.
Each program should be built sepratly. The main P4 file for each program contains leaf and spine logics no need to build leaf/spine seperatly. Example: main file for Saqr is "saqr.p4" which includes the the headers, parser, leaf, and spine implementation.

To build the program we use this script:
```
~/tools/p4_build.sh <path-to-main-p4-file>
```

#### Modify the config file generated by the compiler.
> This step should be done for every program and after the build step.

Each compiled program has a config file generated by the tool which will be used when running the program on the switch. This config file includes both spine and leaf pipe configs. By default, the compiler assumes that switch has four hardware pipelines, but the current switch (EdgeCore Wedge 100BF) has two pipelines. We modify this file to tell the switch run leaf and spine on which pipes. 

The path to the config file is as follows:
```
/home/p4/bf-sde-9.5.0/install/share/p4/targets/tofino/<program-name>.conf
```
In the json file, under ```p4_devices -> p4_programs -> p4_pipelines``` there will be two programs shown under "p4_pipeline_name". In our case, the names for the two programs are "pip_leaf" and "pipe_spine". We need to modify the ""pipe_scope" for these two programs. By default the first one will have a pipe_scope: [0, 2] and second one will have [1, 3]. 
For our switch we will only keep the pipes 0 and 1: 
```
# For the first program (spine)
...
"pipe_scope": [0],
...

# For the second program (leaf)
...
"pipe_scope": [1],
...
``` 

#### Run the code on switch
```
cd $SDE
sudo -E ./run_switchd.sh -p <program-name>
```

#### Setup ports
In the bf-shell insert the following commands:
```
bfshell> ucli
bf-sde> pm
```

Now that we are in port manager, we will execute the port setup commands from the "port_commands.txt".
Simply copy and paste these commands to the CLI. 

> Side Note: This step should be ideally automated using the python controller. I couldn't find the proper library and instructions for the port setup in python.

Use ```show``` command to verify that ports are enabled. Under the "OPR" column,  port status should be "UP", otherwise port is "DOWN". Also, the numbers shown under "D_P" column are the port numbers that are used by the controller. E.g, to forward packet to port 1/0 (first link of the breakout cable), the egress port should set to 132. 

#### Run the controller
Open another shell to the switch contoller and in the second terminal window do the following:

```
cd <path-to-project-dir>
```
Simply run the controller for the program using python. Example:
```
python rs_h_controller.py <placement-setup-arg>
```
The "\<placement-setup-arg\>" can be either "b" (balanced) or "s" (skewed) for the two setups in our experiments.

### Run the Workers and Clients
Documentation on setting up workers and clients are provided in [this repo](https://github.com/parhamyassini/saqr-app-eval). XXX 


## Known issues
 XXX
